<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Admin Secure - Quáº£n LÃ½ Dá»‹ch Vá»¥ Premium</title>
    <link rel="stylesheet" href="admin.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="modal" style="display: block;">
        <div class="modal-content login-content">
            <div class="login-header">
                <h2>ğŸ” Admin Authentication</h2>
                <p>ÄÄƒng nháº­p Ä‘á»ƒ truy cáº­p Admin Panel</p>
            </div>
            
            <div class="login-form">
                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" id="admin-username" placeholder="Nháº­p username admin">
                </div>
                
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="admin-password" placeholder="Nháº­p máº­t kháº©u">
                </div>
                
                <div class="form-group">
                    <label>Google 2FA Code:</label>
                    <input type="text" id="google-2fa" placeholder="Nháº­p mÃ£ 6 sá»‘ tá»« Google Authenticator" maxlength="6">
                </div>
                
                <div class="login-actions">
                    <button class="btn btn-primary" onclick="authenticateAdmin()">ğŸ” ÄÄƒng Nháº­p</button>
                    <button class="btn btn-secondary" onclick="setupGoogle2FA()">ğŸ“± Thiáº¿t Láº­p 2FA</button>
                </div>
                
                <div class="google-auth-section">
                    <div id="g_id_onload"
                         data-client_id="YOUR_GOOGLE_CLIENT_ID"
                         data-callback="handleGoogleAuth"
                         data-auto_prompt="false">
                    </div>
                    <div class="g_id_signin" 
                         data-type="standard"
                         data-size="large"
                         data-theme="dark"
                         data-text="sign_in_with"
                         data-shape="rectangular"
                         data-logo_alignment="left">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed Header -->
    <div class="admin-header" style="display: none;">
        <h1>ğŸ” Admin Secure - Quáº£n LÃ½ Dá»‹ch Vá»¥ Premium</h1>
        <div class="admin-actions">
            <span class="admin-user" id="admin-user-info">ğŸ‘¤ Admin</span>
            <button class="btn btn-secondary" onclick="logoutAdmin()">ğŸšª ÄÄƒng Xuáº¥t</button>
        </div>
    </div>

    <div class="admin-container" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2>ğŸŒ™ Nightmarket</h2>
            <ul class="nav-menu">
                <li><a href="#dashboard" class="active" onclick="showSection('dashboard')">ğŸ“Š Dashboard</a></li>
                <li><a href="#categories" onclick="showSection('categories')">ğŸ“ Danh Má»¥c</a></li>
                <li><a href="#products" onclick="showSection('products')">ğŸ“¦ Sáº£n Pháº©m</a></li>
                <li><a href="#orders" onclick="showSection('orders')">ğŸ›’ ÄÆ¡n HÃ ng</a></li>
                <li><a href="#settings" onclick="showSection('settings')">âš™ï¸ CÃ i Äáº·t</a></li>
                <li><a href="#locket-config" onclick="showSection('locket-config')">ğŸ”‘ Locket Config</a></li>
                <li><a href="#locket-packages" onclick="showSection('locket-packages')">ğŸ“¦ GÃ³i Locket</a></li>
                <li><a href="#payment-config" onclick="showSection('payment-config')">ğŸ’³ Thanh ToÃ¡n</a></li>
                <li><a href="#telegram-notify" onclick="showSection('telegram-notify')">ğŸ“± Telegram</a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="content-section">
                <div class="section-header">
                    <h2>ğŸ“Š Tá»•ng Quan Há»‡ Thá»‘ng</h2>
                    <div class="last-updated" id="last-updated">Äang táº£i...</div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon">ğŸ“¦</div>
                        <div class="number" id="total-products">0</div>
                        <div class="label">Sáº£n Pháº©m</div>
                        <div class="sub-label">Tá»•ng sá»‘ sáº£n pháº©m</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon">ğŸ›’</div>
                        <div class="number" id="total-orders">0</div>
                        <div class="label">ÄÆ¡n HÃ ng</div>
                        <div class="sub-label">Tá»•ng sá»‘ Ä‘Æ¡n hÃ ng</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon">ğŸ’°</div>
                        <div class="number" id="total-revenue">0â‚«</div>
                        <div class="label">Doanh Thu</div>
                        <div class="sub-label">Tá»•ng doanh thu</div>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <h3>ğŸš€ Thao TÃ¡c Nhanh</h3>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="showSection('products')">ğŸ“¦ Quáº£n LÃ½ Sáº£n Pháº©m</button>
                        <button class="btn btn-primary" onclick="showSection('orders')">ğŸ›’ Xem ÄÆ¡n HÃ ng</button>
                        <button class="btn btn-secondary" onclick="showSection('settings')">âš™ï¸ CÃ i Äáº·t</button>
                    </div>
                </div>
            </div>

            <!-- Payment Config Section -->
            <div id="payment-config-section" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2>ğŸ’³ Cáº¥u HÃ¬nh Thanh ToÃ¡n</h2>
                </div>
                <div class="form-container">
                    <div class="form-group">
                        <label>NgÃ¢n hÃ ng:</label>
                        <input type="text" id="payment-bank-name" placeholder="MBBank">
                    </div>
                    <div class="form-group">
                        <label>Sá»‘ tÃ i khoáº£n:</label>
                        <input type="text" id="payment-account-number" placeholder="1613072005">
                    </div>
                    <div class="form-group">
                        <label>Chá»§ tÃ i khoáº£n:</label>
                        <input type="text" id="payment-account-holder" placeholder="NGUYEN HUYNH TUONG AN">
                    </div>
                    <div class="form-group">
                        <label>GiÃ¡ sáº£n pháº©m (â‚«):</label>
                        <input type="number" id="payment-product-price" placeholder="30000">
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="savePaymentConfig()">ğŸ’¾ LÆ°u Cáº¥u HÃ¬nh Thanh ToÃ¡n</button>
                    </div>
                </div>
            </div>

            <!-- Telegram Notification Section -->
            <div id="telegram-notify-section" class="content-section" style="display: none;">
                <div class="section-header">
                    <h2>ğŸ“± Cáº¥u HÃ¬nh Telegram</h2>
                </div>
                <div class="form-container">
                    <div class="form-group">
                        <label>Bot Token:</label>
                        <input type="text" id="telegram-bot-token" placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz">
                    </div>
                    <div class="form-group">
                        <label>Chat ID:</label>
                        <input type="text" id="telegram-chat-id" placeholder="-1001234567890">
                    </div>
                    <div class="form-group">
                        <label>Tráº¡ng thÃ¡i:</label>
                        <select id="telegram-status">
                            <option value="active">Hoáº¡t Ä‘á»™ng</option>
                            <option value="inactive">Táº¡m dá»«ng</option>
                        </select>
                    </div>
                    <div class="form-group checkbox-group">
                        <label>ThÃ´ng bÃ¡o khi cÃ³ Ä‘Æ¡n hÃ ng má»›i:</label>
                        <input type="checkbox" id="telegram-new-order" checked>
                    </div>
                    <div class="form-group checkbox-group">
                        <label>ThÃ´ng bÃ¡o khi thanh toÃ¡n thÃ nh cÃ´ng:</label>
                        <input type="checkbox" id="telegram-payment-success" checked>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="saveTelegramConfig()">ğŸ’¾ LÆ°u Cáº¥u HÃ¬nh Telegram</button>
                        <button class="btn btn-secondary" onclick="testTelegramNotification()">ğŸ§ª Test ThÃ´ng BÃ¡o</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Authentication state
        let isAuthenticated = false;
        let adminUser = null;
        let database = {};

        // Admin credentials (in production, use proper authentication)
        const ADMIN_CREDENTIALS = {
            username: 'admin',
            password: 'admin123',
            google2fa: '123456' // Demo 2FA code
        };

        // Check if user is authenticated
        function checkAuth() {
            const token = localStorage.getItem('admin_token');
            const user = localStorage.getItem('admin_user');
            
            if (token && user) {
                isAuthenticated = true;
                adminUser = JSON.parse(user);
                showAdminPanel();
            } else {
                showLoginModal();
            }
        }

        // Show login modal
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
            document.querySelector('.admin-container').style.display = 'none';
            document.querySelector('.admin-header').style.display = 'none';
        }

        // Show admin panel
        function showAdminPanel() {
            document.getElementById('loginModal').style.display = 'none';
            document.querySelector('.admin-container').style.display = 'flex';
            document.querySelector('.admin-header').style.display = 'flex';
            
            // Update admin user info
            document.getElementById('admin-user-info').textContent = `ğŸ‘¤ ${adminUser.name || 'Admin'}`;
            
            // Load data
            loadFallbackData();
        }

        // Authenticate admin
        function authenticateAdmin() {
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            const google2fa = document.getElementById('google-2fa').value;

            if (username === ADMIN_CREDENTIALS.username && 
                password === ADMIN_CREDENTIALS.password && 
                google2fa === ADMIN_CREDENTIALS.google2fa) {
                
                // Generate token
                const token = 'admin_token_' + Date.now();
                adminUser = {
                    name: username,
                    loginTime: new Date().toISOString()
                };
                
                // Save to localStorage
                localStorage.setItem('admin_token', token);
                localStorage.setItem('admin_user', JSON.stringify(adminUser));
                
                isAuthenticated = true;
                showAdminPanel();
                
                alert('âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng!');
            } else {
                alert('âŒ ThÃ´ng tin Ä‘Äƒng nháº­p khÃ´ng chÃ­nh xÃ¡c!');
            }
        }

        // Setup Google 2FA
        function setupGoogle2FA() {
            alert('ğŸ“± HÆ°á»›ng dáº«n thiáº¿t láº­p Google 2FA:\n\n1. Táº£i app Google Authenticator\n2. QuÃ©t QR code\n3. Nháº­p mÃ£ 6 sá»‘ Ä‘á»ƒ xÃ¡c thá»±c\n\nDemo: Sá»­ dá»¥ng mÃ£ 123456');
        }

        // Handle Google Auth
        function handleGoogleAuth(response) {
            console.log('Google Auth Response:', response);
            // In production, verify the Google token with your backend
            alert('âœ… Google Authentication thÃ nh cÃ´ng!');
        }

        // Logout admin
        function logoutAdmin() {
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_user');
            isAuthenticated = false;
            adminUser = null;
            showLoginModal();
            alert('ğŸšª ÄÃ£ Ä‘Äƒng xuáº¥t!');
        }

        // Load fallback data
        function loadFallbackData() {
            database = {
                categories: [
                    { id: 1, name: "ChatGPT & AI", description: "Dá»‹ch vá»¥ ChatGPT, Claude, Gemini", icon: "ğŸ¤–" },
                    { id: 2, name: "YouTube Premium", description: "YouTube Premium, Music, TV", icon: "ğŸ“º" },
                    { id: 3, name: "CapCut Pro", description: "CapCut Pro, Adobe Premiere", icon: "âœ‚ï¸" }
                ],
                products: [
                    { id: 1, category_id: 1, name: "ChatGPT Plus 1 ThÃ¡ng", price: 200000, stock: 50, status: "active" },
                    { id: 2, category_id: 1, name: "Claude Pro 1 ThÃ¡ng", price: 180000, stock: 30, status: "active" },
                    { id: 3, category_id: 2, name: "YouTube Premium 1 ThÃ¡ng", price: 150000, stock: 100, status: "active" }
                ],
                orders: [
                    { id: "LOCKET1760681418254", customer_name: "sad", product_name: "Locket Gold Key", total: 30000, status: "pending", created_at: "2025-10-17T06:10:18.254Z" },
                    { id: "LOCKET1760681705580", customer_name: "KhÃ¡ch hÃ ng", product_name: "Locket Gold Key", total: 30000, status: "pending", created_at: "2025-10-17T06:15:05.580Z" }
                ],
                locket_packages: [
                    { id: 1, name: "Locket Gold Key", duration: "1 ThÃ¡ng", price: 30000, description: "GÃ³i Locket Gold Key vá»›i tá»‘c Ä‘á»™ cao vÃ  á»•n Ä‘á»‹nh", status: "active" }
                ],
                settings: {
                    site_name: "MMO Services Store",
                    site_description: "Cá»­a hÃ ng dá»‹ch vá»¥ MMO uy tÃ­n - ChatGPT, YouTube, CapCut, Netflix vÃ  nhiá»u hÆ¡n ná»¯a!",
                    contact_email: "admin@andev.site",
                    contact_phone: "0123456789",
                    payment_config: {
                        bankName: "MBBank",
                        accountNumber: "1613072005",
                        accountHolder: "NGUYEN HUYNH TUONG AN",
                        productPrice: 30000
                    },
                    telegram_config: {
                        botToken: "",
                        chatId: "",
                        status: "inactive",
                        notifyNewOrder: true,
                        notifyPaymentSuccess: true
                    }
                }
            };
            updateStats();
        }

        // Update stats
        function updateStats() {
            const productsCount = database.products?.length || 0;
            const ordersCount = database.orders?.length || 0;
            const totalRevenue = database.orders?.reduce((sum, order) => sum + (order.total || 0), 0) || 0;
            
            // Update last updated time
            const lastUpdatedElement = document.getElementById('last-updated');
            if (lastUpdatedElement) {
                lastUpdatedElement.textContent = `Cáº­p nháº­t lÃºc: ${new Date().toLocaleString('vi-VN')}`;
            }
            
            // Animate numbers
            animateNumber('total-products', productsCount);
            animateNumber('total-orders', ordersCount);
            animateNumber('total-revenue', totalRevenue, 'â‚«');
        }

        // Animate number counting
        function animateNumber(elementId, targetValue, suffix = '') {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const startValue = 0;
            const duration = 1000;
            const startTime = performance.now();
            
            function updateNumber(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                const currentValue = Math.floor(startValue + (targetValue - startValue) * easeOutQuart);
                
                if (suffix === 'â‚«') {
                    element.textContent = new Intl.NumberFormat('vi-VN').format(currentValue) + suffix;
                } else {
                    element.textContent = currentValue;
                }
                
                if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                }
            }
            
            requestAnimationFrame(updateNumber);
        }

        // Show section
        function showSection(section) {
            if (!isAuthenticated) {
                alert('âŒ Vui lÃ²ng Ä‘Äƒng nháº­p trÆ°á»›c!');
                return;
            }
            
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(el => {
                el.style.display = 'none';
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-menu a').forEach(el => el.classList.remove('active'));
            
            // Show selected section
            let sectionId = section + '-section';
            
            if (section === 'payment-config') {
                sectionId = 'payment-config-section';
                loadPaymentConfig(); // Load current config when showing payment section
            } else if (section === 'telegram-notify') {
                sectionId = 'telegram-notify-section';
            }
            
            const sectionElement = document.getElementById(sectionId);
            if (sectionElement) {
                sectionElement.style.display = 'block';
            }
            
            // Add active class to clicked nav item
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        // Load payment config from server
        async function loadPaymentConfig() {
            try {
                const response = await fetch('/api/payment-config');
                const data = await response.json();
                
                if (data.success && data.config) {
                    const config = data.config;
                    document.getElementById('payment-bank-name').value = config.bankName || '';
                    document.getElementById('payment-account-number').value = config.accountNumber || '';
                    document.getElementById('payment-account-holder').value = config.accountHolder || '';
                    document.getElementById('payment-product-price').value = config.productPrice || 30000;
                }
            } catch (error) {
                console.error('Error loading payment config:', error);
            }
        }

        // Save Payment Config
        async function savePaymentConfig() {
            if (!isAuthenticated) {
                alert('âŒ Vui lÃ²ng Ä‘Äƒng nháº­p trÆ°á»›c!');
                return;
            }
            
            const paymentConfig = {
                bankName: document.getElementById('payment-bank-name').value,
                accountNumber: document.getElementById('payment-account-number').value,
                accountHolder: document.getElementById('payment-account-holder').value,
                productPrice: parseInt(document.getElementById('payment-product-price').value) || 30000
            };

            // Save to server using payment config API
            try {
                const response = await fetch('/api/payment-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentConfig)
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert('âœ… Cáº¥u hÃ¬nh thanh toÃ¡n Ä‘Ã£ Ä‘Æ°á»£c lÆ°u vÃ  Ä‘á»“ng bá»™!');
                    // Update local database
                    if (!database.settings) database.settings = {};
                    database.settings.payment_config = paymentConfig;
                } else {
                    alert('âš ï¸ Lá»—i khi lÆ°u cáº¥u hÃ¬nh: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving payment config:', error);
                alert('âŒ Lá»—i káº¿t ná»‘i server. Vui lÃ²ng thá»­ láº¡i!');
            }
        }

        // Save Telegram Config
        function saveTelegramConfig() {
            if (!isAuthenticated) {
                alert('âŒ Vui lÃ²ng Ä‘Äƒng nháº­p trÆ°á»›c!');
                return;
            }
            
            if (!database.settings) database.settings = {};
            
            database.settings.telegram_config = {
                botToken: document.getElementById('telegram-bot-token').value,
                chatId: document.getElementById('telegram-chat-id').value,
                status: document.getElementById('telegram-status').value,
                notifyNewOrder: document.getElementById('telegram-new-order').checked,
                notifyPaymentSuccess: document.getElementById('telegram-payment-success').checked
            };

            alert('âœ… Cáº¥u hÃ¬nh Telegram Ä‘Ã£ Ä‘Æ°á»£c lÆ°u!');
        }

        // Test Telegram Notification
        function testTelegramNotification() {
            if (!isAuthenticated) {
                alert('âŒ Vui lÃ²ng Ä‘Äƒng nháº­p trÆ°á»›c!');
                return;
            }
            
            const botToken = document.getElementById('telegram-bot-token').value;
            const chatId = document.getElementById('telegram-chat-id').value;
            
            if (!botToken || !chatId) {
                alert('âŒ Vui lÃ²ng nháº­p Bot Token vÃ  Chat ID!');
                return;
            }

            alert('âœ… Test thÃ´ng bÃ¡o thÃ nh cÃ´ng!');
        }

        // Initialize
        window.addEventListener('load', function() {
            checkAuth();
        });
    </script>
</body>
</html>
